<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç®—å¯©æŸ¥è§€æ¸¬ç«™ - 115å¹´åº¦ç¸½é ç®—</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --bg-light: #f8f9fa;
            
            /* ç‹€æ…‹é¡è‰² */
            --color-remain: #2ecc71;
            --color-freeze: #f1c40f;
            --color-cut: #e74c3c;
        }
        
        html, body { height: 100%; margin: 0; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-light); color: #333; display: flex; flex-direction: column; }
        main { flex: 1; }
        h1, h2, h3, h5, .serif-font { font-family: 'Noto Serif TC', serif; }

        /* HEADER */
        .site-header { background-color: var(--primary-color); padding: 1rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .site-brand { color: white; font-size: 1.5rem; font-weight: 700; text-decoration: none; display: flex; align-items: center; cursor: pointer; }
        .site-brand:hover { color: #ecf0f1; }

        /* BREADCRUMB */
        .custom-breadcrumb { background: transparent; padding: 0; margin-bottom: 1rem; font-size: 0.85rem; }
        .breadcrumb-item a { color: #6c757d; text-decoration: none; cursor: pointer; transition: color 0.2s; }
        .breadcrumb-item a:hover { color: var(--primary-color); text-decoration: underline; }
        .breadcrumb-item.active { color: #adb5bd; }
        .breadcrumb-item + .breadcrumb-item::before { color: #ccc; }

        /* FOOTER */
        .site-footer { background-color: #212529; color: #adb5bd; padding: 2rem 0; margin-top: auto; font-size: 0.9rem; text-align: center; }
        .footer-source { color: #6c757d; font-size: 0.8rem; margin-top: 0.5rem; }

        /* HERO (Centered) */
        .hero-section { 
            min-height: 85vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            color: white; 
            text-align: center; 
            padding: 2rem; 
            position: relative; 
            overflow: hidden; 
        }
        .hero-bg-pattern { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 30px 30px; }
        .hero-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; z-index: 2; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        /* HERO QUICK LINKS (Centered) */
        .hero-quick-links { 
            margin-top: 2rem; 
            z-index: 2; 
            text-align: center; 
            max-width: 800px; 
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        .hero-prompt { font-size: 1.1rem; color: rgba(255, 255, 255, 0.9); margin-bottom: 0.5rem; font-weight: 500; letter-spacing: 1px; }
        
        .btn-quick-kw { 
            background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.6); 
            color: white; margin: 0 8px 12px 8px; border-radius: 50px; 
            padding: 12px 30px; backdrop-filter: blur(5px); 
            transition: all 0.2s; font-size: 1.2rem; font-weight: bold; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-quick-kw:hover { background: white; color: var(--primary-color); transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        
        /* Refresh Button Style */
        .btn-refresh-keywords {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.7);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.85rem;
            margin-bottom: 15px; /* Space between refresh button and keyword buttons */
            transition: all 0.3s;
            cursor: pointer;
            display: inline-block;
        }
        .btn-refresh-keywords:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-color: white;
        }

        .btn-full-budget { 
            background: var(--accent-color); color: white; font-weight: bold; 
            margin-top: 20px; border-radius: 50px; padding: 10px 35px; border: none; 
            transition: all 0.2s; font-size: 1.1rem; 
        }
        .btn-full-budget:hover { background: #c0392b; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* COMPONENTS */
        .category-card { cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; border: none; border-radius: 16px; overflow: hidden; height: 100%; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .category-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .category-header { height: 140px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.8rem; font-weight: bold; position: relative; }
        .cat-icon { font-size: 3rem; margin-bottom: 0.5rem; display: block; text-align: center; }

        .btn-back { border: 1px solid #ced4da; color: #6c757d; background: white; font-size: 0.9rem; padding: 6px 16px; transition: all 0.2s; }
        .btn-back:hover { background-color: #e9ecef; color: #333; border-color: #adb5bd; }

        .keyword-btn { margin: 6px; border-radius: 20px; font-size: 1.1rem; padding: 10px 20px; border: 1px solid #dee2e6; color: #555; background: white; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); white-space: normal; max-width: 320px; text-align: left; display: inline-flex; align-items: center; }
        .keyword-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: #f8f9fa; transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.15); }

        .plan-block { cursor: pointer; transition: all 0.2s; border: 1px solid #e0e0e0; border-left: 4px solid transparent; position: relative; }
        .plan-block:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.08) !important; border-left-color: var(--accent-color); }
        .plan-amount { font-family: 'Courier New', monospace; font-weight: bold; color: var(--accent-color); font-size: 1.4rem; }
        .tag-agency { display: inline-block; background-color: #6c757d; color: white; font-size: 0.8rem; padding: 3px 8px; border-radius: 4px; font-weight: 500; }
        .tag-status { display: inline-block; background-color: #17a2b8; color: white; font-size: 0.8rem; padding: 3px 8px; border-radius: 4px; font-weight: 500; }

        .step-section { display: none; padding-top: 2rem; padding-bottom: 3rem; animation: fadeIn 0.6s ease-out; }
        .step-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* STEP 4 & MODAL */
        .detail-page-card { background: white; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.08); padding: 40px; }
        .detail-agency-tag, .modal-agency-tag { background-color: #95a5a6; color: white; padding: 6px 12px; font-size: 1rem; border-radius: 4px; margin-bottom: 1rem; display: inline-block; }
        .detail-plan-title, .modal-plan-title { font-weight: 800; font-size: 2.2rem; color: #2c3e50; line-height: 1.3; margin-bottom: 1rem; }
        .detail-total-amount, .modal-total-amount { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.8rem; color: #2c3e50; }

        .outcome-container { position: relative; background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 30px; border-left: 5px solid #ced4da; }
        .outcome-text { margin-bottom: 0; color: #555; line-height: 1.7; white-space: pre-line; overflow: hidden; transition: max-height 0.3s ease-out; }
        .outcome-text.collapsed { max-height: 4.8em; mask-image: linear-gradient(180deg, #000 60%, transparent); -webkit-mask-image: linear-gradient(180deg, #000 60%, transparent); }
        .outcome-text.expanded { max-height: none; mask-image: none; -webkit-mask-image: none; }
        .outcome-toggle-btn { font-size: 0.9rem; text-decoration: none; color: var(--primary-color); margin-top: 10px; display: inline-block; cursor: pointer; font-weight: bold; }
        .outcome-toggle-btn:hover { text-decoration: underline; }

        .status-bar-container { height: 30px; border-radius: 6px; overflow: hidden; display: flex; background: #e9ecef; margin: 15px 0 5px 0; }
        .status-seg { display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: bold; white-space: nowrap; overflow: hidden; }
        .status-seg.remain { background-color: var(--color-remain); }
        .status-seg.freeze { background-color: var(--color-freeze); color: #333; }
        .status-seg.cut { background-color: var(--color-cut); }
        
        .chart-wrapper { display: flex; justify-content: space-around; align-items: stretch; height: 250px; padding-bottom: 10px; border-bottom: 2px solid #ddd; margin-top: 25px; }
        .chart-col { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; width: 25%; position: relative; }
        .bar-group { display: flex; width: 100%; align-items: flex-end; justify-content: center; height: 100%; gap: 6px; }
        .v-bar { width: 40%; border-radius: 4px 4px 0 0; transition: height 0.5s ease; position: relative; min-height: 2px; }
        .v-bar.cut { background-color: var(--color-cut); opacity: 0.8; }
        .v-bar.freeze { background-color: var(--color-freeze); opacity: 0.9; }
        .bar-label { margin-top: 10px; font-size: 1rem; font-weight: bold; color: #555; text-align: center; }
        .bar-val { position: absolute; top: -22px; font-size: 0.8rem; width: 100%; text-align: center; color: #444; font-weight: bold; }

        .budget-bar-container { margin-top: 15px; background-color: #f1f1f1; border-radius: 4px; height: 12px; overflow: hidden; display: flex; }
        .budget-bar-segment { height: 100%; }
        .budget-legend { display: flex; flex-wrap: wrap; margin-top: 8px; font-size: 0.8rem; color: #666; }
        .legend-item { display: flex; align-items: center; margin-right: 12px; margin-bottom: 4px; }
        .legend-color { width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }

        .scroll-table-container { max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; margin-top: 20px; }
        .table-custom thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; padding: 12px; }
        .table-custom td { font-size: 1rem; padding: 12px; }

        .general-cut-alert { background-color: #ffe6e6; border-left: 5px solid var(--color-cut); padding: 15px; color: #c0392b; font-weight: bold; margin-top: 20px; border-radius: 6px; font-size: 1.1rem; }
        .legis-label { font-size: 0.9rem; color: #7f8c8d; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; }
        .legis-tag { display: inline-block; padding: 6px 12px; border-radius: 4px; font-size: 0.95rem; margin-right: 8px; margin-bottom: 8px; border: 1px solid; }
        .legis-tag.cut { border-color: var(--color-cut); color: var(--color-cut); background: #fff5f5; }
        .legis-tag.freeze { border-color: var(--color-freeze); color: #b7950b; background: #fffcf0; }
        .legend-row { display: flex; justify-content: center; gap: 15px; font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        .legend-dot { width: 12px; height: 12px; display: inline-block; margin-right: 5px; border-radius: 2px; }

        .step4-footer { border-top: 1px solid #dee2e6; margin-top: 3rem; padding-top: 2rem; text-align: center; }
        .step4-footer h5 { margin-bottom: 1.5rem; color: #6c757d; font-weight: bold; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h4 class="text-muted">æ­£åœ¨é€£ç·šè‡³é ç®—è³‡æ–™åº«...</h4>
    </div>

    <header class="site-header">
        <div class="container">
            <a onclick="goToStep(0)" class="site-brand">
                <span style="font-size: 1.5rem; margin-right: 10px;">ğŸ“Š</span> é ç®—å¯©æŸ¥è§€æ¸¬ç«™
            </a>
        </div>
    </header>

    <main>
        <section id="step-0" class="hero-section step-section active">
            <div class="hero-bg-pattern"></div>
            <div class="container position-relative z-2">
                <span class="badge bg-warning text-dark mb-3 px-3 py-2 rounded-pill">2026 æ”¿åºœé ç®—å°ˆé¡Œ</span>
                
                <h1 class="hero-title">115å¹´åº¦ç¸½é ç®—<br>ä¾†çœ‹çœ‹æˆ‘çš„éŒ¢è¢«èŠ±å»å“ªï¼Ÿ</h1>
                <p class="fs-4 mb-3 opacity-75">ä¸­å¤®æ”¿åºœæ­²å‡ºè¦æ¨¡ç´„ 3 å…†å…ƒã€‚<br>æ‚¨çš„ç´ç¨…éŒ¢å¦‚ä½•åˆ†é…ï¼Ÿå¯©æŸ¥éç¨‹åˆªäº†å¤šå°‘ï¼Ÿ</p>
                
                <div class="hero-quick-links">
                    <p class="hero-prompt">ä½ å¯ä»¥é¸æ“‡ä½ é—œå¿ƒçš„è­°é¡Œï¼Œæˆ–ç›´æ¥çœ‹å®Œæ•´çš„é ç®—â†’</p>
                    
                    <button class="btn-refresh-keywords" onclick="renderRandomKeywords('hero-random-keywords')">
                        ğŸ”„ æ›ä¸€çµ„é—œéµå­—
                    </button>
                    
                    <div id="hero-random-keywords" class="d-flex justify-content-center flex-wrap mb-2"></div>
                    
                    <button class="btn btn-full-budget" onclick="goToStep(1)">çœ‹å®Œæ•´é ç®—</button>
                </div>
            </div>
        </section>

        <div class="container pt-3">
            <nav aria-label="breadcrumb" id="breadcrumb-nav" style="display:none;">
                <ol class="breadcrumb custom-breadcrumb" id="breadcrumb-list"></ol>
            </nav>

            <section id="step-1" class="step-section">
                <div class="mb-3 text-start">
                    <button class="btn btn-back rounded-pill" onclick="handleGlobalBack()">â† å›ä¸Šä¸€é </button>
                </div>
                <div class="text-start mb-5">
                    <h2 class="display-6 fw-bold mb-2">è«‹é¸æ“‡æ”¯å‡ºé¡åˆ¥</h2>
                </div>
                <div class="row g-4" id="category-container"></div>
            </section>

            <section id="step-2" class="step-section">
                <div class="mb-3 text-start">
                    <button class="btn btn-back rounded-pill" onclick="handleGlobalBack()">â† å›ä¸Šä¸€é </button>
                </div>
                <div class="text-start mb-4">
                    <h2 class="mb-1">é¸æ“‡é—œéµå­—...</h2>
                    <small class="text-muted">ç›®å‰é¡åˆ¥ï¼š<span id="selected-category-name" class="text-primary fw-bold"></span></small>
                </div>
                <div class="card border-0 shadow-sm p-4 bg-white rounded-4 text-center">
                    <div id="keywords-container" class="d-flex flex-wrap gap-2 justify-content-center"></div>
                    <div class="mt-4 text-muted fst-italic small">
                        <span class="badge bg-warning text-dark me-1">æ•¸å­—</span> è¡¨ç¤ºé—œéµå­—å°æ‡‰çš„å·¥ä½œè¨ˆç•«æ•¸é‡
                    </div>
                </div>
            </section>

            <section id="step-3" class="step-section">
                <div class="mb-3 text-start">
                    <button id="btn-back-step3" class="btn btn-back rounded-pill" onclick="handleGlobalBack()">â† å›ä¸Šä¸€é </button>
                </div>
                <div class="text-start mb-4">
                    <h2 class="mb-1">é—œéµå­—ï¼šã€Œ<span id="list-view-title" class="text-primary fw-bold"></span>ã€</h2>
                    <small class="text-muted">å…±æ‰¾åˆ° <span id="list-count" class="fw-bold"></span> ç­†è³‡æ–™</small>
                </div>
                <div id="plan-list-container" class="row g-3"></div>
            </section>

            <section id="step-4" class="step-section">
                <div class="mb-3 text-start">
                    <button class="btn btn-back rounded-pill" onclick="handleGlobalBack()">â† å›ä¸Šä¸€é </button>
                </div>

                <div class="detail-page-card">
                    <div class="mb-4">
                        <span class="detail-agency-tag" id="d-agency"></span>
                        <h2 class="detail-plan-title" id="d-title"></h2>
                        <div class="d-flex justify-content-between align-items-end border-bottom pb-3">
                            <span class="text-muted">é ç®—ç¸½é¡</span>
                            <span class="detail-total-amount" id="d-amount"></span>
                        </div>
                    </div>

                    <div class="outcome-container">
                        <h6 class="fw-bold text-secondary mb-2">è¨ˆç•«å…§å®¹èˆ‡é æœŸæˆæœ</h6>
                        <p class="outcome-text collapsed" id="d-outcome-text"></p>
                        <a id="d-outcome-toggle" class="outcome-toggle-btn" onclick="toggleOutcome()">â–¼ å±•é–‹å®Œæ•´å…§å®¹</a>
                    </div>

                    <h6 class="fw-bold text-secondary">é ç®—å¯©æŸ¥çµæœå æ¯”</h6>
                    <div class="status-bar-container" id="d-status-bar"></div>
                    <div class="d-flex justify-content-between small text-muted mb-4">
                        <div class="d-flex align-items-center"><div style="width:10px;height:10px;background:var(--color-remain);margin-right:5px;"></div>é€šé/å‰©é¤˜</div>
                        <div class="d-flex align-items-center"><div style="width:10px;height:10px;background:var(--color-freeze);margin-right:5px;"></div>å‡çµ</div>
                        <div class="d-flex align-items-center"><div style="width:10px;height:10px;background:var(--color-cut);margin-right:5px;"></div>åˆªæ¸›</div>
                    </div>

                    <h6 class="fw-bold text-secondary mt-5">å„éšæ®µå¯©æŸ¥åˆªå‡è®ŠåŒ–</h6>
                    <div class="legend-row">
                        <div><span class="legend-dot" style="background:var(--color-cut)"></span>åˆªæ¸›</div>
                        <div><span class="legend-dot" style="background:var(--color-freeze)"></span>å‡çµ</div>
                    </div>
                    <div class="chart-wrapper" id="d-chart-wrapper"></div>

                    <h6 class="fw-bold text-secondary mt-4">åˆªæ¸›å‡çµç´°ç›®</h6>
                    <div class="scroll-table-container">
                        <table class="table table-hover table-custom mb-0">
                            <thead>
                                <tr>
                                    <th scope="col" width="30%">é …ç›®</th>
                                    <th scope="col">èªªæ˜ / ç†ç”±</th>
                                </tr>
                            </thead>
                            <tbody id="d-details-table-body"></tbody>
                        </table>
                    </div>

                    <div id="d-general-cut" class="general-cut-alert d-none"></div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="legis-label text-danger">ææ¡ˆåˆªæ¸›å§”å“¡</div>
                            <div id="d-legis-cut"></div>
                        </div>
                        <div class="col-md-6 mt-3 mt-md-0">
                            <div class="legis-label text-warning">ææ¡ˆå‡çµå§”å“¡</div>
                            <div id="d-legis-freeze"></div>
                        </div>
                    </div>

                    <div class="step4-footer">
                        <h5>æƒ³äº†è§£å…¶ä»–é ç®—ï¼Ÿ</h5>
                        <div id="step4-random-keywords" class="d-flex justify-content-center flex-wrap mb-3"></div>
                        <button class="btn btn-outline-primary rounded-pill px-4" onclick="goToStep(1)">çœ‹å®Œæ•´é ç®— â†’</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <p class="mb-1 fw-bold">é ç®—å¯©æŸ¥è§€æ¸¬ç«™</p>
            <p class="mb-0">è³‡æ–™ä¾†æºï¼šä¸»è¨ˆç¸½è™•ã€ç«‹æ³•é™¢è­°äº‹æš¨å…¬å ±ç¶²</p>
            <p class="footer-source">æœ¬ç¶²é ç‚ºæ–°èå°ˆé¡Œæ¸¬è©¦ç‰ˆï¼Œä¸¦éæœ€çµ‚è³‡æ–™ï¼Œåƒ…ä¾›åƒè€ƒã€‚</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const PROXY_URL = 'https://corsproxy.io/?';
        const TARGET_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS6ZFEMdgBFyC6O0Axmx7TvcckTzMoDCxrb5V_8gHJmyzBEXx-cLj6RtRWkyUUap-qiK_C2G-GwJFMJ/pub?gid=1922321201&single=true&output=csv';

        const CATEGORY_CONFIG = {
            "state": { name: "åœ‹å‹™æ”¯å‡º", icon: "ğŸ›ï¸", color: "#2c3e50", desc: "ç¸½çµ±è¡Œä½¿è·æ¬Šã€åœ‹å®¶å®‰å…¨æœƒè­°é‹ä½œã€‚", total: "ç´„ 14 å„„å…ƒ" },
            "admin": { name: "è¡Œæ”¿æ”¯å‡º", icon: "ğŸ’¼", color: "#2980b9", desc: "è¡Œæ”¿é™¢åŠå¹•åƒšæ©Ÿé—œé‹ä½œèˆ‡æ”¿ç­–è¦åŠƒã€‚", total: "ç´„ 69 å„„å…ƒ" },
            "legislative": { name: "ç«‹æ³•æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 39 å„„å…ƒ" },
            "judiciary": { name: "å¸æ³•æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 812 å„„å…ƒ" },
            "exam": { name: "è€ƒè©¦æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 26 å„„å…ƒ" },
            "control": { name: "ç›£å¯Ÿæ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 30 å„„å…ƒ" },
            "civil": { name: "æ°‘æ”¿æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 726 å„„å…ƒ" },
            "police": { name: "è­¦æ”¿æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 357 å„„å…ƒ" },
            "foreign": { name: "å¤–äº¤æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 415 å„„å…ƒ" },
            "finance": { name: "è²¡å‹™æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 510 å„„å…ƒ" },
            "overseas": { name: "åƒ‘å‹™æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 26 å„„å…ƒ" },
            "defence": { name: "åœ‹é˜²æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 5488 å„„å…ƒ" },
            "education": { name: "æ•™è‚²æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 3237 å„„å…ƒ" },
            "science": { name: "ç§‘å­¸æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 1817 å„„å…ƒ" },
            "culture": { name: "æ–‡åŒ–æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 513 å„„å…ƒ" },
            "agriculture": { name: "è¾²æ¥­æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 1669 å„„å…ƒ" },
            "industry": { name: "å·¥æ¥­æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 522 å„„å…ƒ" },
            "transport": { name: "äº¤é€šæ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 1622 å„„å…ƒ" },
            "service": { name: "å…¶ä»–ç¶“æ¿Ÿæœå‹™æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 462 å„„å…ƒ" },
            "insurance": { name: "ç¤¾æœƒä¿éšªæ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 6109 å„„å…ƒ" },
            "assistance": { name: "ç¤¾æœƒæ•‘åŠ©æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 88 å„„å…ƒ" },
            "welfare": { name: "ç¦åˆ©æœå‹™æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 1416 å„„å…ƒ" },
            "employment": { name: "åœ‹æ°‘å°±æ¥­æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 20 å„„å…ƒ" },
            "medical": { name: "é†«ç™‚ä¿å¥æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 686 å„„å…ƒ" },
            "environment": { name: "ç’°å¢ƒä¿è­·æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 266 å„„å…ƒ" },
            "pension": { name: "é€€ä¼‘æ’«å¹çµ¦ä»˜æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 1841 å„„å…ƒ" },
            "retirement": { name: "é€€ä¼‘æ’«å¹æ¥­å‹™æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 3.3 å„„å…ƒ" },
            "debt": { name: "å‚µå‹™ä»˜æ¯æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 1059 å„„å…ƒ" },
            "repayment": { name: "é‚„æœ¬ä»˜æ¯äº‹å‹™æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 4.2 å„„å…ƒ" },
            "subsidy": { name: "å°ˆæ¡ˆè£œåŠ©æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 303 å„„å…ƒ" },
            "other": { name: "å…¶ä»–æ”¯å‡º", icon: "âš–ï¸", color: "#27ae60", desc: "ç«‹æ³•é™¢é‹ä½œã€æ³•æ¡ˆå¯©æŸ¥èˆ‡åœ‹æœƒå¤–äº¤ã€‚", total: "ç´„ 81 å„„å…ƒ" }
        };

        const CHART_COLORS = ['#3498db', '#e74c3c', '#f1c40f', '#2ecc71', '#9b59b6', '#34495e', '#e67e22'];

        let groupedData = {};
        let allKeywords = [];
        let historyStack = [];
        let currentView = { step: 0 };

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            if (TARGET_SHEET_URL && TARGET_SHEET_URL.length > 5) {
                const finalUrl = PROXY_URL + encodeURIComponent(TARGET_SHEET_URL);
                Papa.parse(finalUrl, {
                    download: true, header: true,
                    complete: function(results) {
                        processData(results.data);
                        renderCategories();
                        renderRandomKeywords('hero-random-keywords');
                        finishLoading();
                    },
                    error: function(err) {
                        console.error("CSV Load Error", err);
                        useDemoData();
                    }
                });
            } else {
                useDemoData();
            }
        }

        function finishLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 500);
        }

        function useDemoData() {
            // Default demo data in case of error
            const demoRows = [
                { category: 'state', title: 'æ©Ÿé—œåŸºæœ¬é‹ä½œ', agency: 'ç¸½çµ±åºœ', amount: '10.8 å„„å…ƒ', details: 'å¤è¹Ÿä¿®ç¹•;è³‡å®‰ç¶­è­·', review_status: 'ç…§æ¡ˆé€šé', sub_breakdown: 'äººå“¡:700000; å¤è¹Ÿ:300000', cut_frozen_val: '100, 200', review_stats: '100,50; 80,50; 80,50', details_table: 'æ°´é›»|åˆª100', general_cut: '', legis_cut: 'ç‹å¤§æ˜', legis_freeze: 'æå››' }
            ];
            processData(demoRows);
            renderCategories();
            renderRandomKeywords('hero-random-keywords');
            finishLoading();
        }

        function processData(rows) {
            groupedData = {};
            allKeywords = [];
            for (let key in CATEGORY_CONFIG) groupedData[key] = {};

            rows.forEach(row => {
                if (!row.category) return;
                if (!groupedData[row.category]) groupedData[row.category] = {};

                const detailsArray = (row.details && typeof row.details === 'string') ? row.details.split(/[;ï¼›]+/) : [];
                if (detailsArray.length === 0 && row.title) detailsArray.push(row.title);

                let breakdown = [];
                if (row.sub_breakdown) {
                    const parts = row.sub_breakdown.split(/[;ï¼›]+/);
                    parts.forEach(part => {
                        const [name, valStr] = part.split(/[:ï¼š]/);
                        if (name && valStr) {
                            const val = parseInt(valStr.replace(/,/g, '').trim());
                            if (!isNaN(val)) breakdown.push({ name: name.trim(), value: val });
                        }
                    });
                }

                detailsArray.forEach(d => {
                    const keyword = d.trim();
                    if (!keyword) return;

                    if (!allKeywords.includes(keyword)) allKeywords.push(keyword);

                    if (!groupedData[row.category][keyword]) groupedData[row.category][keyword] = [];

                    const planObj = {
                        title: row.title,
                        agency: row.agency,
                        amount: row.amount,
                        reviewStatus: row.review_status || '',
                        outcome: row.outcome || '',
                        breakdown: breakdown, 
                        cutFrozenVal: row.cut_frozen_val || '0,0',
                        reviewStats: row.review_stats || '0,0;0,0;0,0',
                        detailsTable: row.details_table || '',
                        generalCut: row.general_cut || '',
                        legisCut: row.legis_cut || '',
                        legisFreeze: row.legis_freeze || ''
                    };

                    const exists = groupedData[row.category][keyword].some(p => p.title === planObj.title && p.agency === planObj.agency);
                    if (!exists) groupedData[row.category][keyword].push(planObj);
                });
            });
        }

        function getCategoryForKeyword(kw) {
            for(let cat in groupedData) {
                if(groupedData[cat][kw]) return cat;
            }
            return null;
        }

        // ================= NAVIGATION SYSTEM =================

        function pushHistory() {
            historyStack.push(JSON.parse(JSON.stringify(currentView)));
        }

        function handleGlobalBack() {
            if (historyStack.length === 0) {
                goToStep(0, false);
                return;
            }
            const prevState = historyStack.pop();
            restoreState(prevState);
        }

        function restoreState(state) {
            currentView = state;
            
            if (state.step === 0) {
                goToStep(0, false);
            } else if (state.step === 1) {
                goToStep(1, false);
            } else if (state.step === 2) {
                selectCategory(state.catKey, false);
            } else if (state.step === 3) {
                const plans = groupedData[state.catKey][state.kw];
                renderStep3List(state.kw, plans, false, state.catKey); 
            } else if (state.step === 4) {
                renderStep4(state.plan, false);
            }
        }

        // ================= ACTIONS =================

        function goToStep(step, isPush = true) {
            if(isPush) {
                if(document.querySelector('.step-section.active')) {
                    pushHistory();
                }
            }
            
            currentView = { step: step };

            document.querySelectorAll('.step-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 500);
            });
            const target = document.getElementById(`step-${step}`);
            if(target) {
                target.style.display = 'block';
                setTimeout(() => target.classList.add('active'), 10);
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
            updateBreadcrumbs();
        }

        function selectCategory(catKey, isPush = true) {
            if (!groupedData[catKey]) { alert("ç„¡æ­¤é¡åˆ¥è³‡æ–™"); return; }
            
            if(isPush) pushHistory();

            currentView = { step: 2, catKey: catKey };

            const config = CATEGORY_CONFIG[catKey];
            document.getElementById('selected-category-name').innerText = config.name;
            
            const container = document.getElementById('keywords-container');
            container.innerHTML = ''; 
            Object.keys(groupedData[catKey]).forEach(keyword => {
                const plans = groupedData[catKey][keyword];
                const count = plans.length;
                const btn = document.createElement('button');
                btn.className = `btn keyword-btn`;
                let html = `${keyword} <span class="badge bg-warning text-dark ms-1 rounded-pill">${count}</span>`;
                btn.innerHTML = html;
                btn.onclick = () => renderStep3List(keyword, plans);
                container.appendChild(btn);
            });

            switchSection(2);
            updateBreadcrumbs();
        }

        // â˜…â˜…â˜… Re-added renderCategories Function â˜…â˜…â˜…
        function renderCategories() {
            const container = document.getElementById('category-container');
            if(!container) return;
            container.innerHTML = '';
            for (const [key, config] of Object.entries(CATEGORY_CONFIG)) {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-12';
                col.innerHTML = `
                    <div class="card category-card">
                        <div class="category-header" style="background-color: ${config.color};">
                            <div><div class="cat-icon">${config.icon}</div>${config.name}</div>
                        </div>
                        <div class="card-body p-4">
                            <p class="card-text text-muted">${config.desc}</p>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">ç¸½é ç®—</small>
                                <span class="fw-bold text-dark">${config.total}</span>
                            </div>
                        </div>
                    </div>`;
                col.querySelector('.category-card').onclick = () => selectCategory(key);
                container.appendChild(col);
            }
        }

        function renderStep3List(keyword, plans, isPush = true, explicitCatKey = null) {
            if(isPush) pushHistory();

            let catKey = explicitCatKey || currentView.catKey;
            if(!catKey) {
                catKey = getCategoryForKeyword(keyword);
            }

            currentView = { step: 3, catKey: catKey, kw: keyword };

            document.getElementById('list-view-title').innerText = keyword;
            document.getElementById('list-count').innerText = plans.length;
            
            const backBtn = document.getElementById('btn-back-step3');
            backBtn.innerText = 'â† å›ä¸Šä¸€é ';

            const container = document.getElementById('plan-list-container');
            container.innerHTML = '';

            plans.forEach(plan => {
                let chartHtml = '';
                let legendHtml = '';
                if (plan.breakdown && plan.breakdown.length > 0) {
                    const totalVal = plan.breakdown.reduce((sum, item) => sum + item.value, 0);
                    let bars = '';
                    let legends = '';
                    plan.breakdown.forEach((item, idx) => {
                        const percent = (item.value / totalVal) * 100;
                        const color = CHART_COLORS[idx % CHART_COLORS.length];
                        bars += `<div class="budget-bar-segment" style="width: ${percent}%; background-color: ${color};" title="${item.name}: ${percent.toFixed(1)}%"></div>`;
                        legends += `<div class="legend-item"><div class="legend-color" style="background-color: ${color};"></div><span>${item.name}</span></div>`;
                    });
                    chartHtml = `<div class="budget-bar-container" style="height:10px;">${bars}</div>`;
                    legendHtml = `<div class="budget-legend">${legends}</div>`;
                }

                let statusHtml = plan.reviewStatus ? `<span class="tag-status">${plan.reviewStatus}</span>` : '';
                
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4'; 
                col.innerHTML = `
                    <div class="card shadow-sm h-100 plan-block">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="tag-agency">${plan.agency}</span>
                                ${statusHtml}
                            </div>
                            <h5 class="card-title fw-bold mb-3">${plan.title}</h5>
                            <div class="d-flex justify-content-end align-items-center mb-2">
                                <small class="text-muted me-2">é ç®—é‡‘é¡</small>
                                <span class="plan-amount">${plan.amount}</span>
                            </div>
                            ${chartHtml}
                            ${legendHtml}
                        </div>
                    </div>
                `;
                col.querySelector('.plan-block').onclick = () => renderStep4(plan);
                container.appendChild(col);
            });

            switchSection(3);
            updateBreadcrumbs();
        }

        function renderStep4(plan, isPush = true) {
            if(isPush) pushHistory();

            currentView = { 
                step: 4, 
                catKey: currentView.catKey,
                kw: currentView.kw, 
                plan: plan 
            };

            document.getElementById('d-agency').innerText = plan.agency;
            document.getElementById('d-title').innerText = plan.title;
            document.getElementById('d-amount').innerText = plan.amount;

            const outcomeText = document.getElementById('d-outcome-text');
            const outcomeToggle = document.getElementById('d-outcome-toggle');
            outcomeText.classList.remove('expanded');
            outcomeText.classList.add('collapsed');
            outcomeToggle.innerText = 'â–¼ å±•é–‹å®Œæ•´å…§å®¹';
            
            if (plan.outcome && plan.outcome.length > 0) {
                outcomeText.innerText = plan.outcome;
                if(plan.outcome.length < 60) {
                    outcomeToggle.style.display = 'none';
                    outcomeText.classList.remove('collapsed');
                } else {
                    outcomeToggle.style.display = 'inline-block';
                }
            } else {
                outcomeText.innerText = "å°šç„¡è©³ç´°è¨ˆç•«å…§å®¹ã€‚";
                outcomeToggle.style.display = 'none';
                outcomeText.classList.remove('collapsed');
            }

            const cfVals = plan.cutFrozenVal.split(/[,ï¼Œ]/).map(s => parseInt(s.trim()) || 0);
            const cutVal = cfVals[0] || 0;
            const freezeVal = cfVals[1] || 0;
            let totalVal = parseInt(plan.amount.replace(/[^0-9]/g, ''));
            if(plan.amount.includes('å„„')) totalVal *= 100000000;
            else if(plan.amount.includes('è¬')) totalVal *= 10000;
            else totalVal = cutVal + freezeVal + 100000; 

            const cutPct = Math.min((cutVal / totalVal) * 100, 100);
            const freezePct = Math.min((freezeVal / totalVal) * 100, 100);
            const remainPct = Math.max(0, 100 - cutPct - freezePct);

            const barContainer = document.getElementById('d-status-bar');
            barContainer.innerHTML = `
                <div class="status-seg remain" style="width: ${remainPct}%">${remainPct > 10 ? remainPct.toFixed(1)+'%' : ''}</div>
                <div class="status-seg freeze" style="width: ${freezePct}%">${freezePct > 5 ? 'å‡'+freezePct.toFixed(1)+'%' : ''}</div>
                <div class="status-seg cut" style="width: ${cutPct}%">${cutPct > 5 ? 'åˆª'+cutPct.toFixed(1)+'%' : ''}</div>
            `;

            const stages = plan.reviewStats.split(/[;ï¼›]/);
            const stageNames = ['å§”å“¡æœƒ', 'é»¨åœ˜å”å•†', 'é™¢æœƒ'];
            const chartWrapper = document.getElementById('d-chart-wrapper');
            chartWrapper.innerHTML = '';
            let maxVal = 1;
            stages.forEach(s => {
                const parts = s.split(/[,ï¼Œ]/).map(v=>parseInt(v)||0);
                if(parts[0] > maxVal) maxVal = parts[0];
                if(parts[1] > maxVal) maxVal = parts[1];
            });
            stages.forEach((s, idx) => {
                if(idx > 2) return;
                const parts = s.split(/[,ï¼Œ]/).map(v=>parseInt(v)||0); 
                const cVal = parts[0];
                const fVal = parts[1];
                const cH = (cVal / maxVal) * 100;
                const fH = (fVal / maxVal) * 100; 
                const col = document.createElement('div');
                col.className = 'chart-col';
                col.innerHTML = `
                    <div class="bar-group">
                        <div class="v-bar cut" style="height:${cH}%">${cH > 5 ? `<span class="bar-val">${cVal}</span>` : ''}</div>
                        <div class="v-bar freeze" style="height:${fH}%">${fH > 5 ? `<span class="bar-val">${fVal}</span>` : ''}</div>
                    </div>
                    <div class="bar-label">${stageNames[idx]}</div>
                `;
                chartWrapper.appendChild(col);
            });

            const tbody = document.getElementById('d-details-table-body');
            tbody.innerHTML = '';
            const detailRows = plan.detailsTable.split(/[;ï¼›]/);
            detailRows.forEach(rowStr => {
                if(!rowStr.trim()) return;
                const cols = rowStr.split(/[|ï½œ]/);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="fw-bold text-primary">${cols[0]}</td><td>${cols[1] || ''}</td>`;
                tbody.appendChild(tr);
            });

            const genCutDiv = document.getElementById('d-general-cut');
            if(plan.generalCut) {
                genCutDiv.innerText = plan.generalCut;
                genCutDiv.classList.remove('d-none');
            } else {
                genCutDiv.classList.add('d-none');
            }

            const renderTags = (containerId, str, cssClass) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                if(!str) { container.innerHTML = '<span class="text-muted small">ç„¡</span>'; return; }
                const names = str.split(/[,ï¼Œã€]/);
                names.forEach(n => {
                    if(!n.trim()) return;
                    const tag = document.createElement('span');
                    tag.className = `legis-tag ${cssClass}`;
                    tag.innerText = n.trim();
                    container.appendChild(tag);
                });
            };
            renderTags('d-legis-cut', plan.legisCut, 'cut');
            renderTags('d-legis-freeze', plan.legisFreeze, 'freeze');

            renderRandomKeywords('step4-random-keywords');

            switchSection(4);
            updateBreadcrumbs();
        }

        function renderRandomKeywords(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (allKeywords.length === 0) return;
            const shuffled = allKeywords.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 3);
            selected.forEach(kw => {
                const btn = document.createElement('button');
                btn.className = 'btn-quick-kw'; 
                if(containerId === 'step4-random-keywords') {
                    btn.className = 'btn btn-outline-secondary rounded-pill me-2 mb-2';
                }
                btn.innerText = kw;
                
                const targetCat = getCategoryForKeyword(kw);
                btn.onclick = () => {
                    if (targetCat) {
                        const targetPlans = groupedData[targetCat][kw];
                        renderStep3List(kw, targetPlans, true, targetCat); 
                    } else { alert("ç„¡æ³•æ‰¾åˆ°æ­¤é—œéµå­—"); }
                };
                container.appendChild(btn);
            });
        }

        function switchSection(stepNum) {
            document.querySelectorAll('.step-section').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 500);
            });
            const target = document.getElementById(`step-${stepNum}`);
            if(target) {
                target.style.display = 'block';
                setTimeout(() => target.classList.add('active'), 10);
                window.scrollTo({top: 0, behavior: 'smooth'});
            }
        }

        function toggleOutcome() {
            const text = document.getElementById('d-outcome-text');
            const btn = document.getElementById('d-outcome-toggle');
            if (text.classList.contains('collapsed')) {
                text.classList.remove('collapsed');
                text.classList.add('expanded');
                btn.innerText = 'â–² æ”¶åˆå…§å®¹';
            } else {
                text.classList.remove('expanded');
                text.classList.add('collapsed');
                btn.innerText = 'â–¼ å±•é–‹å®Œæ•´å…§å®¹';
            }
        }

        function updateBreadcrumbs() {
            const nav = document.getElementById('breadcrumb-nav');
            const list = document.getElementById('breadcrumb-list');
            list.innerHTML = '';

            if(currentView.step === 0) { nav.style.display = 'none'; return; }
            nav.style.display = 'block';

            let homeLi = document.createElement('li');
            homeLi.className = 'breadcrumb-item';
            homeLi.innerHTML = '<a onclick="goToStep(0)">é¦–é </a>';
            list.appendChild(homeLi);

            if(currentView.step >= 1) {
                let catLi = document.createElement('li');
                catLi.className = 'breadcrumb-item';
                if(currentView.step === 1) { catLi.classList.add('active'); catLi.innerText = 'é¸æ“‡é¡åˆ¥'; }
                else { 
                    const catName = (currentView.catKey && CATEGORY_CONFIG[currentView.catKey]) ? CATEGORY_CONFIG[currentView.catKey].name : 'é¡åˆ¥';
                    catLi.innerHTML = `<a onclick="goToStep(1)">${catName}</a>`; 
                }
                list.appendChild(catLi);
            }

            if(currentView.step >= 2) {
                let kwLi = document.createElement('li');
                kwLi.className = 'breadcrumb-item';
                if(currentView.step === 2) { kwLi.classList.add('active'); kwLi.innerText = 'é¸æ“‡é—œéµå­—'; }
                else { 
                    kwLi.innerHTML = `<a onclick="selectCategory('${currentView.catKey}')">${currentView.kw || 'é—œéµå­—'}</a>`; 
                }
                list.appendChild(kwLi);
            }

            if(currentView.step >= 3) {
                let listLi = document.createElement('li');
                listLi.className = 'breadcrumb-item';
                if(currentView.step === 3) { listLi.classList.add('active'); listLi.innerText = 'è¨ˆç•«æ¸…å–®'; }
                else { 
                    listLi.innerHTML = `<a onclick="renderStep3List('${currentView.kw}', groupedData['${currentView.catKey}']['${currentView.kw}'], true, '${currentView.catKey}')">è¨ˆç•«æ¸…å–®</a>`;
                }
                list.appendChild(listLi);
            }

            if(currentView.step === 4) {
                let detailLi = document.createElement('li');
                detailLi.className = 'breadcrumb-item active';
                detailLi.innerText = 'è©³ç´°å…§å®¹';
                list.appendChild(detailLi);
            }
        }

        function goToStep(step) {
            pushHistory();
            currentView = { step: step };
            switchSection(step);
            updateBreadcrumbs();
        }
    </script>
</body>
</html>
